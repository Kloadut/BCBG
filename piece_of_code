upstream backend  {
  ip_hash;
  #server 127.0.0.1:3456;
  #server sunoct062.noho.st:3456;
  server backup.yunohost.org:3456;
}

upstream database {
    postgres_server 127.0.0.1 dbname=dbdb user=pgpg password=psswd;
}

server {
    listen 3457;

    location ~ /pg/(.*) {
        internal;
        set $hash $1;
        postgres_pass     database;
        rds_json on;
        postgres_query    "SELECT * FROM operations WHERE hash='$hash';";
        #postgres_query    PUT "SELECT contentlength FROM operations WHERE hash='$hash';";
        #postgres_output   value;
    }


    location ~ /uri/(.*) {
        #if ($request_uri ~* /uri/(.*)) {
            set $hash $1;
            set $contentlength '';
            set $type '';
            rewrite_by_lua '
              local res = ngx.location.capture("/pg/" .. ngx.var.hash)
              local cjson = require "cjson"
              local restbl = cjson.decode(res.body)[1]
              --ngx.var.contentlength = cjson.decode(res.body)["contentlength"]
              ngx.var.contentlength = restbl["contentlength"]
              ngx.var.type = restbl["type"]
            ';
            #}
            if ($content_length != $contentlength) {
                 echo $contentlength;
            }
            if ($request_method = $type) {
                 echo $type;
            }

